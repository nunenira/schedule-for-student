<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ประกาศข่าวสาร - Benchamarachuthit</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
        min-height: 100vh;
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #1e88e5;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .logo {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        color: white;
        font-size: 24px;
        overflow: hidden;
      }

      .logo img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .page-title {
        font-size: 24px;
        font-weight: 600;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .nav-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
        text-decoration: none;
      }

      .nav-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        color: white;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 30px 20px;
      }

      .page-header {
        text-align: center;
        margin-bottom: 40px;
      }

      .page-main-title {
        font-size: 32px;
        color: #1e3c72;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
      }

      .page-main-title i {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }

      .page-subtitle {
        color: #666;
        font-size: 16px;
      }

      .controls-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      }

      .controls-grid {
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 20px;
        align-items: end;
      }

      .search-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .search-label {
        font-size: 14px;
        font-weight: 600;
        color: #333;
      }

      .search-input {
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: #f8f9fa;
      }

      .search-input:focus {
        outline: none;
        border-color: #1e88e5;
        background: white;
        box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .filter-label {
        font-size: 14px;
        font-weight: 600;
        color: #333;
      }

      .filter-select {
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 14px;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .filter-select:focus {
        outline: none;
        border-color: #1e88e5;
        background: white;
      }

      .sort-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .sort-select {
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 14px;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .announcements-stats {
        background: linear-gradient(135deg, #1e88e5, #1565c0);
        color: white;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 30px;
        text-align: center;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
      }

      .stat-item {
        text-align: center;
      }

      .stat-number {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 14px;
        opacity: 0.9;
      }

      .announcements-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 25px;
        margin-bottom: 40px;
      }

      .announcement-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border-left: 5px solid #e0e0e0;
        position: relative;
        overflow: hidden;
        cursor: pointer;
      }

      .announcement-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      }

      .announcement-card.priority-high {
        border-left-color: #dc3545;
      }

      .announcement-card.priority-high::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #dc3545, #c82333);
      }

      .announcement-card.priority-medium {
        border-left-color: #ffc107;
      }

      .announcement-card.priority-medium::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #ffc107, #e0a800);
      }

      .announcement-card.priority-low {
        border-left-color: #28a745;
      }

      .announcement-card.priority-low::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #28a745, #1e7e34);
      }

      .announcement-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      .announcement-priority {
        background: #f8f9fa;
        color: #666;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .announcement-priority.priority-high {
        background: #fff5f5;
        color: #dc3545;
      }

      .announcement-priority.priority-medium {
        background: #fffbf0;
        color: #f57c00;
      }

      .announcement-priority.priority-low {
        background: #f8fff8;
        color: #2e7d32;
      }

      .announcement-date {
        font-size: 13px;
        color: #999;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .announcement-title {
        font-size: 20px;
        font-weight: 700;
        color: #333;
        margin-bottom: 15px;
        line-height: 1.4;
      }

      .announcement-content {
        color: #666;
        font-size: 15px;
        line-height: 1.6;
        margin-bottom: 20px;
      }

      .announcement-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 20px;
      }

      .announcement-tag {
        background: #e3f2fd;
        color: #1565c0;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
      }

      .announcement-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-top: 20px;
        border-top: 1px solid #f0f0f0;
      }

      .announcement-author {
        font-size: 13px;
        color: #666;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .announcement-actions {
        display: flex;
        gap: 10px;
      }

      .action-btn {
        background: transparent;
        border: 1px solid #1e88e5;
        color: #1e88e5;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .action-btn:hover {
        background: #1e88e5;
        color: white;
      }

      .action-btn.secondary {
        border-color: #6c757d;
        color: #6c757d;
      }

      .action-btn.secondary:hover {
        background: #6c757d;
        color: white;
      }

      .no-announcements {
        background: white;
        border-radius: 15px;
        padding: 60px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        color: #666;
      }

      .no-announcements i {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
        color: #1e88e5;
      }

      .no-announcements h3 {
        font-size: 24px;
        margin-bottom: 10px;
        color: #333;
      }

      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 40px;
      }

      .pagination-btn {
        background: white;
        border: 2px solid #e0e0e0;
        color: #666;
        padding: 10px 16px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .pagination-btn:hover:not(:disabled) {
        border-color: #1e88e5;
        color: #1e88e5;
      }

      .pagination-btn.active {
        background: #1e88e5;
        border-color: #1e88e5;
        color: white;
      }

      .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .pagination-info {
        background: white;
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 14px;
        color: #666;
        border: 2px solid #f0f0f0;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 20px;
        width: 90%;
        max-width: 700px;
        max-height: 80%;
        overflow: hidden;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-50px) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .modal-header {
        background: linear-gradient(135deg, #1e88e5, #1565c0);
        color: white;
        padding: 25px;
        position: relative;
      }

      .modal-close {
        position: absolute;
        top: 15px;
        right: 20px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .modal-close:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .modal-body {
        padding: 30px;
        max-height: 60vh;
        overflow-y: auto;
      }

      .modal-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 10px;
      }

      .modal-meta {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
        opacity: 0.9;
      }

      .modal-content-text {
        font-size: 16px;
        line-height: 1.7;
        color: #333;
        white-space: pre-wrap;
      }

      @media (max-width: 768px) {
        .controls-grid {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .announcements-grid {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .container {
          padding: 20px 15px;
        }

        .modal-content {
          width: 95%;
          margin: 10% auto;
        }

        .modal-body {
          padding: 20px;
        }

        .page-main-title {
          font-size: 24px;
          flex-direction: column;
          gap: 10px;
        }
      }

      .loading-content {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: #666;
        gap: 15px;
        font-size: 16px;
      }

      .loading-content i {
        animation: spin 1s linear infinite;
        font-size: 24px;
      }
    </style>
  </head>
  <body>
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
    </div>

    <div class="header">
      <div class="header-left">
        <div class="logo">
          <img src="/image/logo.png" alt="Logo" />
        </div>
        <h1 class="page-title">ประกาศข่าวสาร</h1>
      </div>
      <div class="header-right">
        <a href="dashboard.html" class="nav-btn">
          <i class="bi bi-house-fill"></i>
          <span>หน้าแรก</span>
        </a>
        <a href="planner.html" class="nav-btn">
          <i class="bi bi-calendar-plus"></i>
          <span>แพลนเนอร์</span>
        </a>
        <button class="nav-btn" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i>
          <span>ออกจากระบบ</span>
        </button>
      </div>
    </div>

    <div class="container">
      <div class="page-header">
        <h1 class="page-main-title">
          <i class="bi bi-megaphone-fill"></i>
          ประกาศข่าวสารทั้งหมด
        </h1>
        <p class="page-subtitle">ติดตามข่าวสารและประกาศสำคัญจากโรงเรียน</p>
      </div>

      <div class="controls-section">
        <div class="controls-grid">
          <div class="search-group">
            <label class="search-label">ค้นหาประกาศ</label>
            <input
              type="text"
              class="search-input"
              id="searchInput"
              placeholder="ค้นหาจากหัวข้อหรือเนื้อหา..."
            />
          </div>

          <div class="filter-group">
            <label class="filter-label">กรองตามความสำคัญ</label>
            <select class="filter-select" id="priorityFilter">
              <option value="all">ทั้งหมด</option>
              <option value="high">สำคัญมาก</option>
              <option value="medium">สำคัญ</option>
              <option value="low">ทั่วไป</option>
            </select>
          </div>

          <div class="sort-group">
            <label class="filter-label">เรียงตาม</label>
            <select class="sort-select" id="sortSelect">
              <option value="newest">ใหม่ล่าสุด</option>
              <option value="oldest">เก่าสุด</option>
              <option value="priority">ความสำคัญ</option>
            </select>
          </div>
        </div>
      </div>

      <div class="announcements-stats" id="announcementsStats">
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-number" id="totalCount">0</div>
            <div class="stat-label">ประกาศทั้งหมด</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="highPriorityCount">0</div>
            <div class="stat-label">สำคัญมาก</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="mediumPriorityCount">0</div>
            <div class="stat-label">สำคัญ</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="lowPriorityCount">0</div>
            <div class="stat-label">ทั่วไป</div>
          </div>
        </div>
      </div>

      <div id="announcementsContainer">
        <div class="loading-content">
          <i class="bi bi-arrow-clockwise"></i>
          กำลังโหลดประกาศ...
        </div>
      </div>

      <div class="pagination" id="pagination"></div>
    </div>

    <!-- Modal for detailed view -->
    <div id="announcementModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <button class="modal-close" onclick="closeModal()">&times;</button>
          <h2 class="modal-title" id="modalTitle"></h2>
          <div class="modal-meta" id="modalMeta"></div>
        </div>
        <div class="modal-body">
          <div class="modal-content-text" id="modalContent"></div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        query,
        orderBy,
        onSnapshot,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBfrhiskCagKW3X-IybZYZh0_K4F1j7724",
        authDomain: "schedule-for-student.firebaseapp.com",
        projectId: "schedule-for-student",
        storageBucket: "schedule-for-student.firebasestorage.app",
        messagingSenderId: "454469640747",
        appId: "1:454469640747:web:991147e163e36e9d2bc06e",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      let currentUser = null;
      let allAnnouncements = [];
      let filteredAnnouncements = [];
      let announcementListener = null;
      let currentPage = 1;
      const itemsPerPage = 6;

      // Show loading overlay
      showLoading(true);

      // Auth state observer
      onAuthStateChanged(auth, async (user) => {
        if (user && user.emailVerified) {
          currentUser = user;
          await loadAnnouncements();
        } else {
          showLoading(false);
          window.location.href = "index.html";
        }
      });

      async function loadAnnouncements() {
        try {
          if (announcementListener) {
            announcementListener();
          }

          const announcementsQuery = query(
            collection(db, "announcements"),
            orderBy("createdAt", "desc")
          );

          announcementListener = onSnapshot(
            announcementsQuery,
            (snapshot) => {
              allAnnouncements = [];
              snapshot.forEach((doc) => {
                const data = doc.data();
                let createdAt;

                if (data.createdAt) {
                  if (data.createdAt.toDate) {
                    createdAt = data.createdAt.toDate();
                  } else if (data.createdAt.seconds) {
                    createdAt = new Date(data.createdAt.seconds * 1000);
                  } else {
                    createdAt = new Date(data.createdAt);
                  }
                } else {
                  createdAt = new Date();
                }

                allAnnouncements.push({
                  id: doc.id,
                  ...data,
                  createdAt: createdAt,
                });
              });

              applyFiltersAndSort();
              updateStats();
              renderAnnouncements();
              showLoading(false);
            },
            (error) => {
              console.error("Error listening to announcements:", error);
              renderError();
              showLoading(false);
            }
          );
        } catch (error) {
          console.error("Error setting up announcement listener:", error);
          renderError();
          showLoading(false);
        }
      }

      function applyFiltersAndSort() {
        const searchTerm = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const priorityFilter = document.getElementById("priorityFilter").value;
        const sortBy = document.getElementById("sortSelect").value;

        // Apply filters
        filteredAnnouncements = allAnnouncements.filter((announcement) => {
          const matchesSearch =
            !searchTerm ||
            announcement.title?.toLowerCase().includes(searchTerm) ||
            announcement.content?.toLowerCase().includes(searchTerm);

          const matchesPriority =
            priorityFilter === "all" ||
            announcement.priority === priorityFilter;

          return matchesSearch && matchesPriority;
        });

        // Apply sorting
        switch (sortBy) {
          case "oldest":
            filteredAnnouncements.sort(
              (a, b) => new Date(a.createdAt) - new Date(b.createdAt)
            );
            break;
          case "priority":
            const priorityOrder = { high: 3, medium: 2, low: 1 };
            filteredAnnouncements.sort((a, b) => {
              const aPriority = priorityOrder[a.priority] || 1;
              const bPriority = priorityOrder[b.priority] || 1;
              if (aPriority === bPriority) {
                return new Date(b.createdAt) - new Date(a.createdAt);
              }
              return bPriority - aPriority;
            });
            break;
          default: // newest
            filteredAnnouncements.sort(
              (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
            );
        }

        currentPage = 1; // Reset to first page
      }

      function updateStats() {
        const stats = {
          total: allAnnouncements.length,
          high: allAnnouncements.filter((a) => a.priority === "high").length,
          medium: allAnnouncements.filter((a) => a.priority === "medium")
            .length,
          low: allAnnouncements.filter((a) => a.priority === "low").length,
        };

        document.getElementById("totalCount").textContent = stats.total;
        document.getElementById("highPriorityCount").textContent = stats.high;
        document.getElementById("mediumPriorityCount").textContent =
          stats.medium;
        document.getElementById("lowPriorityCount").textContent = stats.low;
      }

      function renderAnnouncements() {
        const container = document.getElementById("announcementsContainer");

        if (filteredAnnouncements.length === 0) {
          container.innerHTML = `
            <div class="no-announcements">
              <i class="bi bi-megaphone"></i>
              <h3>ไม่พบประกาศ</h3>
              <p>ไม่มีประกาศที่ตรงกับเงื่อนไขการค้นหา</p>
            </div>
          `;
          document.getElementById("pagination").innerHTML = "";
          return;
        }

        // Calculate pagination
        const totalPages = Math.ceil(
          filteredAnnouncements.length / itemsPerPage
        );
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const currentAnnouncements = filteredAnnouncements.slice(
          startIndex,
          endIndex
        );

        // Render announcements
        const announcementsHTML = `
          <div class="announcements-grid">
            ${currentAnnouncements
              .map((announcement) => renderAnnouncementCard(announcement))
              .join("")}
          </div>
        `;

        container.innerHTML = announcementsHTML;

        // Render pagination
        renderPagination(totalPages);
      }

      function renderAnnouncementCard(announcement) {
        const priorityClass = announcement.priority || "low";
        const priorityText =
          {
            high: "สำคัญมาก",
            medium: "สำคัญ",
            low: "ทั่วไป",
          }[priorityClass] || "ทั่วไป";

        const tags = announcement.tags || [];
        const author = announcement.author || "ผู้ดูแลระบบ";

        const formatDate = (date) => {
          return date.toLocaleDateString("th-TH", {
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
        };

        const truncateContent = (content, maxLength = 150) => {
          if (!content) return "ไม่มีเนื้อหา";
          return content.length > maxLength
            ? content.substring(0, maxLength) + "..."
            : content;
        };

        return `
          <div class="announcement-card priority-${priorityClass}" onclick="openModal('${
          announcement.id
        }')">
            <div class="announcement-header">
              <span class="announcement-priority priority-${priorityClass}">
                ${priorityText}
              </span>
              <div class="announcement-date">
                <i class="bi bi-clock"></i>
                ${formatDate(announcement.createdAt)}
              </div>
            </div>
            
            <h3 class="announcement-title">${
              announcement.title || "ไม่มีหัวข้อ"
            }</h3>
            
            <div class="announcement-content">
              ${truncateContent(announcement.content)}
            </div>
            
            ${
              tags.length > 0
                ? `
              <div class="announcement-tags">
                ${tags
                  .slice(0, 3)
                  .map((tag) => `<span class="announcement-tag">${tag}</span>`)
                  .join("")}
                ${
                  tags.length > 3
                    ? `<span class="announcement-tag">+${
                        tags.length - 3
                      } เพิ่มเติม</span>`
                    : ""
                }
              </div>
            `
                : ""
            }
            
            <div class="announcement-footer">
              <div class="announcement-author">
                <i class="bi bi-person-circle"></i>
                ${author}
              </div>
              <div class="announcement-actions">
                <button class="action-btn" onclick="event.stopPropagation(); openModal('${
                  announcement.id
                }')">
                  <i class="bi bi-eye"></i>
                  อ่านเต็ม
                </button>
                <button class="action-btn secondary" onclick="event.stopPropagation(); shareAnnouncement('${
                  announcement.id
                }')">
                  <i class="bi bi-share"></i>
                  แชร์
                </button>
              </div>
            </div>
          </div>
        `;
      }

      function renderPagination(totalPages) {
        const paginationContainer = document.getElementById("pagination");

        if (totalPages <= 1) {
          paginationContainer.innerHTML = "";
          return;
        }

        let paginationHTML = `
          <button class="pagination-btn" onclick="changePage(${
            currentPage - 1
          })" ${currentPage === 1 ? "disabled" : ""}>
            <i class="bi bi-chevron-left"></i>
          </button>
        `;

        // Show page numbers
        const maxVisiblePages = 5;
        let startPage = Math.max(
          1,
          currentPage - Math.floor(maxVisiblePages / 2)
        );
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        if (endPage - startPage + 1 < maxVisiblePages) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        if (startPage > 1) {
          paginationHTML += `<button class="pagination-btn" onclick="changePage(1)">1</button>`;
          if (startPage > 2) {
            paginationHTML += `<span class="pagination-info">...</span>`;
          }
        }

        for (let i = startPage; i <= endPage; i++) {
          paginationHTML += `
            <button class="pagination-btn ${
              i === currentPage ? "active" : ""
            }" onclick="changePage(${i})">
              ${i}
            </button>
          `;
        }

        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            paginationHTML += `<span class="pagination-info">...</span>`;
          }
          paginationHTML += `<button class="pagination-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
        }

        paginationHTML += `
          <button class="pagination-btn" onclick="changePage(${
            currentPage + 1
          })" ${currentPage === totalPages ? "disabled" : ""}>
            <i class="bi bi-chevron-right"></i>
          </button>
        `;

        paginationHTML += `
          <div class="pagination-info">
            แสดง ${(currentPage - 1) * itemsPerPage + 1} - ${Math.min(
          currentPage * itemsPerPage,
          filteredAnnouncements.length
        )} 
            จาก ${filteredAnnouncements.length} รายการ
          </div>
        `;

        paginationContainer.innerHTML = paginationHTML;
      }

      function renderError() {
        const container = document.getElementById("announcementsContainer");
        container.innerHTML = `
          <div class="no-announcements">
            <i class="bi bi-megaphone"></i>
            <h3>ยังไม่มีประกาศ</h3>
            <p>ไม่สามารถโหลดประกาศได้ กรุณาลองใหม่อีกครั้ง</p>
          </div>
        `;
      }

      function openModal(announcementId) {
        const announcement = allAnnouncements.find(
          (a) => a.id === announcementId
        );
        if (!announcement) return;

        const modal = document.getElementById("announcementModal");
        const modalTitle = document.getElementById("modalTitle");
        const modalMeta = document.getElementById("modalMeta");
        const modalContent = document.getElementById("modalContent");

        const priorityText =
          {
            high: "สำคัญมาก",
            medium: "สำคัญ",
            low: "ทั่วไป",
          }[announcement.priority] || "ทั่วไป";

        const formatDate = (date) => {
          return date.toLocaleDateString("th-TH", {
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
        };

        modalTitle.textContent = announcement.title || "ไม่มีหัวข้อ";

        modalMeta.innerHTML = `
          <div style="display: flex; align-items: center; gap: 5px;">
            <i class="bi bi-clock"></i>
            ${formatDate(announcement.createdAt)}
          </div>
          <div style="display: flex; align-items: center; gap: 5px;">
            <i class="bi bi-flag"></i>
            ${priorityText}
          </div>
          <div style="display: flex; align-items: center; gap: 5px;">
            <i class="bi bi-person-circle"></i>
            ${announcement.author || "ผู้ดูแลระบบ"}
          </div>
        `;

        let contentHTML = announcement.content || "ไม่มีเนื้อหา";

        if (announcement.tags && announcement.tags.length > 0) {
          contentHTML += `
            <div style="margin-top: 30px;">
              <h4 style="margin-bottom: 10px; color: #666;">หมวดหมู่:</h4>
              <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${announcement.tags
                  .map((tag) => `<span class="announcement-tag">${tag}</span>`)
                  .join("")}
              </div>
            </div>
          `;
        }

        modalContent.innerHTML = contentHTML;
        modal.style.display = "block";
        document.body.style.overflow = "hidden";
      }

      function closeModal() {
        const modal = document.getElementById("announcementModal");
        modal.style.display = "none";
        document.body.style.overflow = "auto";
      }

      function changePage(page) {
        const totalPages = Math.ceil(
          filteredAnnouncements.length / itemsPerPage
        );
        if (page < 1 || page > totalPages) return;

        currentPage = page;
        renderAnnouncements();

        // Scroll to top
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function shareAnnouncement(announcementId) {
        const announcement = allAnnouncements.find(
          (a) => a.id === announcementId
        );
        if (!announcement) return;

        if (navigator.share) {
          navigator
            .share({
              title: announcement.title,
              text: announcement.content,
              url: window.location.href + "?id=" + announcementId,
            })
            .catch(console.error);
        } else {
          // Fallback for browsers that don't support Web Share API
          const shareText = `${announcement.title}\n\n${announcement.content}\n\n${window.location.href}?id=${announcementId}`;
          navigator.clipboard
            .writeText(shareText)
            .then(() => {
              alert("คัดลอกลิงก์แล้ว!");
            })
            .catch(() => {
              alert("ไม่สามารถแชร์ได้ กรุณาคัดลอกลิงก์ด้วยตนเอง");
            });
        }
      }

      function showLoading(show = true) {
        const overlay = document.getElementById("loadingOverlay");
        overlay.style.display = show ? "flex" : "none";
      }

      async function logout() {
        try {
          showLoading(true);
          if (announcementListener) {
            announcementListener();
          }
          await signOut(auth);
          window.location.href = "index.html";
        } catch (error) {
          console.error("Logout error:", error);
        } finally {
          showLoading(false);
        }
      }

      // Event listeners for filters and search
      document.getElementById("searchInput").addEventListener("input", () => {
        applyFiltersAndSort();
        renderAnnouncements();
      });

      document
        .getElementById("priorityFilter")
        .addEventListener("change", () => {
          applyFiltersAndSort();
          renderAnnouncements();
        });

      document.getElementById("sortSelect").addEventListener("change", () => {
        applyFiltersAndSort();
        renderAnnouncements();
      });

      // Close modal when clicking outside
      window.addEventListener("click", (event) => {
        const modal = document.getElementById("announcementModal");
        if (event.target === modal) {
          closeModal();
        }
      });

      // Handle URL parameters (for direct links to announcements)
      window.addEventListener("load", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const announcementId = urlParams.get("id");
        if (announcementId) {
          // Wait a bit for announcements to load, then open modal
          setTimeout(() => {
            openModal(announcementId);
          }, 1000);
        }
      });

      // Make functions available globally
      window.openModal = openModal;
      window.closeModal = closeModal;
      window.changePage = changePage;
      window.shareAnnouncement = shareAnnouncement;
      window.logout = logout;
    </script>
  </body>
</html>
