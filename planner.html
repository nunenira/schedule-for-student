<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assignment Planner</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
        min-height: 100vh;
      }

      .logo {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        color: white;
        font-size: 24px;
        overflow: hidden;
      }

      .logo img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #1e88e5;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .logo {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        color: white;
        font-size: 18px;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .nav-btn,
      .logout-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
        text-decoration: none;
      }

      .nav-btn:hover,
      .logout-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        color: white;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
      }

      .user-details {
        text-align: right;
      }

      .user-name {
        font-weight: 600;
        font-size: 14px;
      }

      .user-class {
        font-size: 12px;
        opacity: 0.9;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 30px 20px;
      }

      .current-time-card {
        background: linear-gradient(135deg, #1e88e5, #1565c0);
        color: white;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(30, 136, 229, 0.3);
      }

      .current-time {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 5px;
      }

      .current-date {
        font-size: 14px;
        opacity: 0.9;
      }

      .alert {
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
        display: none;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .tabs {
        background: white;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      }

      .tab-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .tab-btn {
        padding: 10px 20px;
        background: #f8f9fa;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .tab-btn.active {
        background: linear-gradient(135deg, #1e88e5, #1565c0);
        color: white;
        border-color: #1e88e5;
      }

      .tab-content {
        display: none;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
      }

      .tab-content.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
      }

      .card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      }

      .card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }

      .card-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #1e88e5, #1565c0);
        color: white;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
      }

      .card-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .assignment-list {
        display: grid;
        gap: 15px;
      }

      .assignment-item {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border-left: 4px solid #1e88e5;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        transform: translateY(0);
      }

      .assignment-item:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      }

      .assignment-item.overdue {
        border-left-color: #dc3545;
      }

      .assignment-item.due-soon {
        border-left-color: #ffc107;
      }

      .assignment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .assignment-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .assignment-subject {
        font-size: 14px;
        color: #666;
        background: #f8f9fa;
        padding: 4px 8px;
        border-radius: 6px;
      }

      .assignment-due {
        font-size: 14px;
        color: #666;
        margin-bottom: 8px;
      }

      .assignment-description {
        color: #555;
        font-size: 14px;
        line-height: 1.4;
      }

      .assignment-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .btn-edit {
        background: #17a2b8;
        color: white;
      }

      .btn-delete {
        background: #dc3545;
        color: white;
      }

      .btn-complete {
        background: #28a745;
        color: white;
      }

      .btn-notify {
        background: #ff6b35;
        color: white;
      }

      .btn-small:hover {
        transform: translateY(-1px);
        opacity: 0.9;
      }

      .add-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #1e88e5, #1565c0);
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 5px 20px rgba(30, 136, 229, 0.4);
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .add-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(30, 136, 229, 0.5);
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
      }

      .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .modal-title {
        font-size: 24px;
        font-weight: 600;
        color: #333;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #999;
      }

      .close-btn:hover {
        color: #333;
      }

      .form-group {
        margin-bottom: 20px;
        position: relative;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 15px 50px 15px 50px;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        font-size: 16px;
        background: #f8f9fa;
        transition: all 0.3s ease;
        outline: none;
        appearance: none;
      }

      .form-group textarea {
        min-height: 80px;
        resize: vertical;
        border-radius: 15px;
      }

      .form-group select {
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 20px center;
        background-size: 16px;
        cursor: pointer;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        border-color: #1e88e5;
        background-color: white;
        box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
      }

      .form-group label {
        position: absolute;
        top: 15px;
        left: 50px;
        color: #999;
        font-size: 16px;
        pointer-events: none;
        transition: all 0.3s ease;
      }

      .form-group input:focus + label,
      .form-group input:not(:placeholder-shown) + label,
      .form-group select:focus + label,
      .form-group select:not([value=""]) + label,
      .form-group textarea:focus + label,
      .form-group textarea:not(:placeholder-shown) + label {
        top: -8px;
        left: 45px;
        font-size: 12px;
        color: #1e88e5;
        background: white;
        padding: 0 5px;
      }

      .input-icon {
        position: absolute;
        left: 18px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        font-size: 16px;
      }

      .submit-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #1e88e5, #1565c0);
        color: white;
        border: none;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
      }

      .submit-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(30, 136, 229, 0.3);
      }

      .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .calendar-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      }

      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .calendar-nav {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #1e88e5;
        padding: 10px;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .calendar-nav:hover {
        background: #f0f8ff;
        transform: scale(1.1);
      }

      .calendar-month {
        font-size: 24px;
        font-weight: 600;
        color: #333;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      }

      .calendar-day {
        background: white;
        padding: 12px 8px;
        text-align: center;
        font-size: 14px;
        min-height: 45px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .calendar-day:hover {
        background: #f0f8ff;
        transform: scale(1.05);
      }

      .calendar-day.other-month {
        color: #ccc;
        background: #f8f9fa;
      }

      .calendar-day.today {
        background: linear-gradient(135deg, #1e88e5, #1565c0);
        color: white;
        font-weight: 600;
        box-shadow: 0 3px 10px rgba(30, 136, 229, 0.3);
      }

      .calendar-day.has-assignment {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        border: 2px solid #ffc107;
      }

      .calendar-day.has-assignment:hover {
        background: linear-gradient(135deg, #ffeaa7, #ffdc4e);
      }

      .assignment-dot {
        width: 8px;
        height: 8px;
        background: #1e88e5;
        border-radius: 50%;
        margin-top: 3px;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.7;
          transform: scale(1.2);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }

      .assignment-dot.multiple {
        background: #dc3545;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.3);
      }

      .upcoming-assignments {
        margin-top: 25px;
        padding-top: 20px;
        border-top: 2px solid #f0f0f0;
      }

      .upcoming-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .assignment-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        margin-bottom: 8px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #1e88e5;
        transition: all 0.3s ease;
      }

      .assignment-info:hover {
        background: #e3f2fd;
        transform: translateX(5px);
      }

      .assignment-info:last-child {
        margin-bottom: 0;
      }

      .assignment-info-title {
        font-weight: 600;
        color: #333;
      }

      .assignment-info-date {
        font-size: 12px;
        color: #666;
        background: white;
        padding: 4px 8px;
        border-radius: 6px;
      }

      .empty-state i {
        font-size: 48px;
        margin-bottom: 10px;
        display: block;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .notification-settings {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      }

      /* Responsive styles */
      @media (max-width: 768px) {
        .header {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .header-left {
          justify-content: center;
        }

        .header-right {
          justify-content: center;
          flex-wrap: wrap;
        }

        .user-details {
          display: block;
        }

        .tab-buttons {
          flex-direction: column;
        }

        .assignment-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .assignment-actions {
          justify-content: flex-start;
        }

        .calendar-grid {
          font-size: 12px;
        }

        .calendar-day {
          min-height: 35px;
          padding: 8px 4px;
        }

        .modal-content {
          width: 95%;
          margin: 10px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
          padding: 12px 40px 12px 40px;
          font-size: 14px;
        }

        .form-group label {
          left: 40px;
          top: 12px;
        }

        .input-icon {
          left: 14px;
        }
      }

      @media (max-width: 480px) {
        .container {
          padding: 20px 10px;
        }

        .card {
          padding: 15px;
        }

        .assignment-item {
          padding: 15px;
        }

        .add-btn {
          bottom: 20px;
          right: 20px;
          width: 50px;
          height: 50px;
          font-size: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
    </div>

    <div class="header">
      <div class="header-left">
        <div class="logo">
        <img src="/image/logo.png" alt="Logo" />
      </div>
        <h1>Assignment Planner</h1>
      </div>
      <div class="header-right">
        <a href="dashboard.html" class="nav-btn">
          <i class="bi bi-house"></i>
          <span> ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
        </a>
        <a href="announce.html" class="nav-btn">
          <i class="bi bi-megaphone-fill"></i>
          <span>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</span>
        </a>
        <div class="user-info">
          <div class="user-avatar">
            <i class="bi bi-person-fill"></i>
          </div>
          <div class="user-details">
            <div class="user-name" id="userName">Loading...</div>
            <div class="user-class" id="userClass">Loading...</div>
          </div>
        </div>
        <button class="logout-btn" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i>
          <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
        </button>
      </div>
    </div>

    <div class="container">
      <div class="current-time-card">
        <div class="current-time" id="currentTime">Loading...</div>
        <div class="current-date" id="currentDate">Loading...</div>
      </div>

      <div class="alert alert-success" id="successAlert"></div>
      <div class="alert alert-error" id="errorAlert"></div>

      <!-- Email Notification Settings -->
      <div class="notification-settings">
        <div class="card-header">
          <div class="card-icon">
            <i class="bi bi-envelope"></i>
          </div>
          <h2 class="card-title">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•</h2>
        </div>
        <div
          style="
            background: #e8f5e8;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
          "
        >
          <div
            style="
              display: flex;
              align-items: center;
              gap: 10px;
              margin-bottom: 8px;
            "
          >
            <i
              class="bi bi-check-circle-fill"
              style="color: #28a745; font-size: 18px"
            ></i>
            <div style="font-weight: 600; color: #155724">
              ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
            </div>
          </div>
          <div style="font-size: 14px; color: #155724">
            ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î 1 ‡∏ß‡∏±‡∏ô
          </div>
        </div>
        <div class="form-group" style="margin-bottom: 0">
          <i class="bi bi-envelope input-icon"></i>
          <input type="email" id="notificationEmail" placeholder=" " />
          <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</label>
        </div>
      </div>

      <div class="tabs">
        <div class="tab-buttons">
          <div class="tab-btn active" onclick="showTab('assignments')">
            <i class="bi bi-file-text"></i> ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢
          </div>
          <div class="tab-btn" onclick="showTab('exams')">
            <i class="bi bi-pencil-square"></i> ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö
          </div>
          <div class="tab-btn" onclick="showTab('calendar')">
            <i class="bi bi-calendar3"></i> ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
          </div>
        </div>
      </div>

      <div id="assignmentsTab" class="tab-content active">
        <div class="card">
          <div class="card-header">
            <div class="card-icon">
              <i class="bi bi-file-text"></i>
            </div>
            <h2 class="card-title">‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
          </div>
          <div class="assignment-list" id="assignmentsList">
            <div class="empty-state">
              <i class="bi bi-file-text"></i>
              <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô!</p>
            </div>
          </div>
        </div>
      </div>

      <div id="examsTab" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div class="card-icon">
              <i class="bi bi-pencil-square"></i>
            </div>
            <h2 class="card-title">‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á</h2>
          </div>
          <div class="assignment-list" id="examsList">
            <div class="empty-state">
              <i class="bi bi-pencil-square"></i>
              <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°!</p>
            </div>
          </div>
        </div>
      </div>

      <div id="calendarTab" class="tab-content">
        <div class="calendar-container">
          <div class="calendar-header">
            <button class="calendar-nav" onclick="changeMonth(-1)">
              <i class="bi bi-chevron-left"></i>
            </button>
            <h3 class="calendar-month" id="calendarMonth">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô 2568</h3>
            <button class="calendar-nav" onclick="changeMonth(1)">
              <i class="bi bi-chevron-right"></i>
            </button>
          </div>
          <div class="calendar-grid" id="calendarGrid">
            <!-- Calendar will be generated here -->
          </div>
          <div class="upcoming-assignments">
            <h4 class="upcoming-title">
              <i class="bi bi-clock-history"></i>
              ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á
            </h4>
            <div id="upcomingAssignmentsList">
              <!-- Upcoming assignments will be shown here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <button class="add-btn" onclick="showAddModal()">
      <i class="bi bi-plus"></i>
    </button>

    <!-- Add/Edit Assignment Modal -->
    <div class="modal" id="assignmentModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="modalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</h3>
          <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <form id="assignmentForm">
          <div class="form-group">
            <i class="bi bi-file-text input-icon"></i>
            <input type="text" id="assignmentTitle" placeholder=" " required />
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label>
          </div>

          <div class="form-group">
            <i class="bi bi-book input-icon"></i>
            <select id="assignmentSubject" required>
              <option value="" disabled selected hidden></option>
              <option value="‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå">‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå</option>
              <option value="‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÄ‡∏û‡∏¥‡πà‡∏°">‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÄ‡∏û‡∏¥‡πà‡∏°</option>
              <option value="‡∏ä‡∏µ‡∏ß‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤">‡∏ä‡∏µ‡∏ß‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</option>
              <option value="‡πÄ‡∏Ñ‡∏°‡∏µ">‡πÄ‡∏Ñ‡∏°‡∏µ</option>
              <option value="‡πÑ‡∏ó‡∏¢">‡πÑ‡∏ó‡∏¢</option>
              <option value="‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡πà‡∏≠">
                ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡πà‡∏≠
              </option>
              <option value="‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏ü‡∏±‡∏á‡∏û‡∏π‡∏î">‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏ü‡∏±‡∏á‡∏û‡∏π‡∏î</option>
              <option value="‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ó‡∏±‡∏Å‡∏©‡∏∞">‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ó‡∏±‡∏Å‡∏©‡∏∞</option>
              <option value="‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£">
                ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£
              </option>
              <option value="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
              <option value="‡πÇ‡∏Ñ‡∏£‡∏á‡∏á‡∏≤‡∏ô">‡πÇ‡∏Ñ‡∏£‡∏á‡∏á‡∏≤‡∏ô</option>
              <option value="‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®">‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®</option>
              <option value="‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß">‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß</option>
              <option value="‡∏®‡∏¥‡∏•‡∏õ‡∏∞">‡∏®‡∏¥‡∏•‡∏õ‡∏∞</option>
              <option value="‡∏û‡∏•‡∏∞">‡∏û‡∏•‡∏∞</option>
              <option value="‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</option>
              <option value="‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô</option>
              <option value="‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ">
                ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ
              </option>
            </select>
            <label>‡∏ß‡∏¥‡∏ä‡∏≤</label>
          </div>

          <div class="form-group">
            <i class="bi bi-calendar input-icon"></i>
            <input type="date" id="assignmentDate" required />
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</label>
          </div>

          <div class="form-group">
            <i class="bi bi-clock input-icon"></i>
            <select id="assignmentPeriod" required>
              <option value="" disabled selected hidden></option>
              <option value="1">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà 1</option>
              <option value="2">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà 2</option>
              <option value="3">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà 3</option>
              <option value="4">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà 4</option>
              <option value="5">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà 5</option>
              <option value="6">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà 6</option>
              <option value="7">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà 7</option>
              <option value="8">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà 8</option>
              <option value="9">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà 9</option>
              <option value="10">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà 10</option>
              <option value="end-of-day">‡∏õ‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
            </select>
            <label>‡∏Ñ‡∏≤‡∏ö</label>
          </div>

          <div class="form-group">
            <i class="bi bi-card-text input-icon"></i>
            <select id="assignmentType" required>
              <option value="" disabled selected hidden></option>
              <option value="assignment">‡∏á‡∏≤‡∏ô</option>
              <option value="exam">‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</option>
              <option value="project">‡πÇ‡∏Ñ‡∏£‡∏á‡∏á‡∏≤‡∏ô</option>
              <option value="quiz">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</option>
            </select>
            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
          </div>

          <div class="form-group">
            <i class="bi bi-text-paragraph input-icon"></i>
            <textarea
              id="assignmentDescription"
              placeholder=" "
              rows="3"
            ></textarea>
            <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
          </div>

          <button type="submit" class="submit-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô</button>
        </form>
      </div>
    </div>

    <!-- Email Notification Modal -->
    <div class="modal" id="emailModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•</h3>
          <button class="close-btn" onclick="closeEmailModal()">&times;</button>
        </div>
        <form id="emailForm">
          <div class="form-group">
            <i class="bi bi-envelope input-icon"></i>
            <input type="email" id="recipientEmail" placeholder=" " required />
            <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</label>
          </div>

          <div class="form-group">
            <i class="bi bi-type input-icon"></i>
            <input type="text" id="emailSubject" placeholder=" " required />
            <label>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label>
          </div>

          <div class="form-group">
            <i class="bi bi-text-paragraph input-icon"></i>
            <textarea
              id="emailMessage"
              placeholder=" "
              rows="5"
              required
            ></textarea>
            <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</label>
          </div>

          <button type="submit" class="submit-btn">‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•</button>
        </form>
      </div>
    </div>

    <!-- EmailJS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        collection,
        addDoc,
        setDoc,
        updateDoc,
        deleteDoc,
        query,
        where,
        onSnapshot,
        Timestamp,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDL3EA-xEzbnRrj328ENKbHzLrYnFIPeAM",
        authDomain: "schedule-for-student-bd640.firebaseapp.com",
        projectId: "schedule-for-student-bd640",
        storageBucket: "schedule-for-student-bd640.firebasestorage.app",
        messagingSenderId: "170313991017",
        appId: "1:170313991017:web:5c4e2f6ddf9819647af3f8",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // EmailJS Configuration - Replace with your actual IDs
      const EMAILJS_CONFIG = {
        serviceId: "service_gdf0asd", // Replace with your service ID
        templateId: "template_eo9viex", // Replace with your template ID
        publicKey: "BlyC7YtBGu3TjJU-P", // Replace with your public key
      };

      // Initialize EmailJS
      emailjs.init(EMAILJS_CONFIG.publicKey);

      let currentUser = null;
      let currentStudentData = null;
      let assignments = [];
      let assignmentListener = null;
      let currentCalendarDate = getBangkokTime();
      let editingAssignmentId = null;
      let notificationSettings = {
        enabled: true, // Always enabled by default
        email: "",
        lastCheck: null,
      };

      // Bangkok timezone utilities
      function getBangkokTime() {
        return new Date(
          new Date().toLocaleString("en-US", { timeZone: "Asia/Bangkok" })
        );
      }

      function formatBangkokTime(date) {
        return date.toLocaleString("th-TH", {
          timeZone: "Asia/Bangkok",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: false,
        });
      }

      function formatBangkokDate(date) {
        return date.toLocaleDateString("th-TH", {
          timeZone: "Asia/Bangkok",
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });
      }

      function getBangkokDateOnly(date = getBangkokTime()) {
        const bangkokDate = new Date(
          date.toLocaleString("en-US", { timeZone: "Asia/Bangkok" })
        );
        return new Date(
          bangkokDate.getFullYear(),
          bangkokDate.getMonth(),
          bangkokDate.getDate()
        );
      }

      function updateCurrentTime() {
        const now = getBangkokTime();
        document.getElementById("currentTime").textContent =
          formatBangkokTime(now);
        document.getElementById("currentDate").textContent =
          formatBangkokDate(now);
      }

      // Update time every second
      setInterval(updateCurrentTime, 1000);
      updateCurrentTime();

      showLoading(true);

      onAuthStateChanged(auth, async (user) => {
        if (user && user.emailVerified) {
          currentUser = user;
          await loadUserData(user);
        } else {
          showLoading(false);
          window.location.href = "index.html";
        }
      });

      async function loadUserData(user) {
        try {
          const studentDoc = await getDoc(doc(db, "students", user.uid));

          if (studentDoc.exists()) {
            currentStudentData = studentDoc.data();
            updateUserInfo(currentStudentData);
            await loadNotificationSettings(user.uid);
            await loadUserAssignments(user.uid);
            startNotificationCheck();
          } else {
            showAlert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "error");
            window.location.href = "index.html";
          }
        } catch (error) {
          console.error("Error loading user data:", error);
          showAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "error");
        } finally {
          showLoading(false);
        }
      }

      function updateUserInfo(studentData) {
        document.getElementById("userName").textContent =
          studentData.studentId || "‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
        document.getElementById("userClass").textContent = `${
          studentData.gradeLevel || ""
        }/${studentData.classroom || ""}`;
      }

      async function loadUserAssignments(userId) {
        try {
          if (assignmentListener) {
            assignmentListener();
          }

          const assignmentsQuery = query(
            collection(db, "assignments"),
            where("userId", "==", userId)
          );

          assignmentListener = onSnapshot(
            assignmentsQuery,
            (snapshot) => {
              assignments = [];
              snapshot.forEach((doc) => {
                const data = doc.data();
                let dueDate;

                // Handle different date formats
                if (data.dueDate) {
                  if (data.dueDate.toDate) {
                    dueDate = data.dueDate.toDate();
                  } else if (data.dueDate.seconds) {
                    dueDate = new Date(data.dueDate.seconds * 1000);
                  } else {
                    dueDate = new Date(data.dueDate);
                  }
                } else {
                  dueDate = new Date();
                }

                assignments.push({
                  id: doc.id,
                  ...data,
                  dueDate: dueDate,
                });
              });

              assignments.sort(
                (a, b) => new Date(a.dueDate) - new Date(b.dueDate)
              );
              renderAssignments();
              renderExams();
              generateCalendar();
            },
            (error) => {
              console.error("Error listening to assignments:", error);
              showAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô", "error");
            }
          );
        } catch (error) {
          console.error("Error setting up assignment listener:", error);
          showAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô", "error");
        }
      }

      function showLoading(show = true) {
        const overlay = document.getElementById("loadingOverlay");
        overlay.style.display = show ? "flex" : "none";
      }

      function showAlert(message, type) {
        const alertDiv = document.getElementById(
          type === "success" ? "successAlert" : "errorAlert"
        );
        const otherAlert = document.getElementById(
          type === "success" ? "errorAlert" : "successAlert"
        );

        otherAlert.style.display = "none";
        alertDiv.textContent = message;
        alertDiv.style.display = "block";

        setTimeout(() => {
          alertDiv.style.display = "none";
        }, 5000);
      }

      function formatDate(date) {
        if (!date) return "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà";
        try {
          // Convert to Bangkok time for display
          const bangkokDate = new Date(
            date.toLocaleString("en-US", { timeZone: "Asia/Bangkok" })
          );
          return bangkokDate.toLocaleDateString("th-TH", {
            weekday: "long",
            month: "long",
            day: "numeric",
            year: "numeric",
          });
        } catch (error) {
          return "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
        }
      }

      function formatAssignmentDue(assignment) {
        const dateStr = formatDate(assignment.dueDate);
        if (assignment.period) {
          if (assignment.period === "end-of-day") {
            return `${dateStr} - ‡∏õ‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô`;
          } else {
            return `${dateStr} - ‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà ${assignment.period}`;
          }
        }
        return dateStr;
      }

      async function saveAssignment(assignmentData) {
        try {
          showLoading(true);

          if (!currentUser) {
            showAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô", "error");
            return;
          }

          const assignmentToSave = {
            ...assignmentData,
            userId: currentUser.uid,
            createdAt: Timestamp.now(),
            updatedAt: Timestamp.now(),
          };

          await addDoc(collection(db, "assignments"), assignmentToSave);
          showAlert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", "success");
        } catch (error) {
          console.error("Error saving assignment:", error);
          showAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô: " + error.message, "error");
        } finally {
          showLoading(false);
        }
      }

      async function updateAssignment(assignmentId, updatedData) {
        try {
          showLoading(true);

          const assignmentRef = doc(db, "assignments", assignmentId);
          const updateData = {
            ...updatedData,
            updatedAt: Timestamp.now(),
          };

          await updateDoc(assignmentRef, updateData);
          showAlert("‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", "success");
        } catch (error) {
          console.error("Error updating assignment:", error);
          showAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô: " + error.message, "error");
        } finally {
          showLoading(false);
        }
      }

      async function deleteAssignmentFromDb(assignmentId) {
        try {
          showLoading(true);

          const assignmentRef = doc(db, "assignments", assignmentId);
          await deleteDoc(assignmentRef);
          showAlert("‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", "success");
        } catch (error) {
          console.error("Error deleting assignment:", error);
          showAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô: " + error.message, "error");
        } finally {
          showLoading(false);
        }
      }

      async function markAssignmentComplete(assignmentId) {
        try {
          const assignmentRef = doc(db, "assignments", assignmentId);
          await updateDoc(assignmentRef, {
            completed: true,
            completedAt: Timestamp.now(),
            updatedAt: Timestamp.now(),
          });
          showAlert("‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß!", "success");
        } catch (error) {
          console.error("Error marking assignment complete:", error);
          showAlert(
            "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô: " + error.message,
            "error"
          );
        }
      }

      // Email notification functions
      async function loadNotificationSettings(userId) {
        try {
          const settingsDoc = await getDoc(
            doc(db, "notificationSettings", userId)
          );
          if (settingsDoc.exists()) {
            const settings = settingsDoc.data();
            // Always keep notifications enabled, only load email
            notificationSettings.email = settings.email || "";
            notificationSettings.lastCheck = settings.lastCheck || null;
          }
          updateNotificationUI();
        } catch (error) {
          console.error("Error loading notification settings:", error);
        }
      }

      async function saveNotificationSettings() {
        try {
          if (!currentUser) return;

          const settingsRef = doc(db, "notificationSettings", currentUser.uid);

          await setDoc(settingsRef, {
            ...notificationSettings,
            enabled: true, // Always save as enabled
          });

          showAlert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", "success");
        } catch (error) {
          console.error("Error saving notification settings:", error);
          showAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤", "error");
        }
      }

      function updateNotificationUI() {
        const emailInput = document.getElementById("notificationEmail");
        emailInput.value = notificationSettings.email || "";
      }

      async function sendEmailNotification(to, subject, message) {
        try {
          showLoading(true);

          // EmailJS parameters
          const templateParams = {
            to_email: notificationSettings.email,
            subject: subject,
            message: message,
            from_name: "Assignment Planner",
            reply_to: "noreply@assignmentplanner.com",
          };

          // Send email using EmailJS
          const response = await emailjs.send(
            EMAILJS_CONFIG.serviceId,
            EMAILJS_CONFIG.templateId,
            templateParams
          );

          console.log("Email sent successfully:", response);
          showAlert("‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìß", "success");

          // Store notification record in Firebase
          if (currentUser) {
            await addDoc(collection(db, "emailNotifications"), {
              userId: currentUser.uid,
              to: to,
              subject: subject,
              message: message,
              sentAt: Timestamp.now(),
              type: "manual",
              status: "sent",
              emailjsResponse: response.status,
            });
          }
        } catch (error) {
          console.error("Error sending email:", error);

          // Handle specific EmailJS errors
          let errorMessage = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•";

          if (error.status === 400) {
            errorMessage = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö";
          } else if (error.status === 402) {
            errorMessage = "‡πÄ‡∏Å‡∏¥‡∏ô‡∏Çl√≠mit ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤";
          } else if (error.status === 403) {
            errorMessage = "‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ EmailJS ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
          } else if (error.status === 404) {
            errorMessage = "‡πÑ‡∏°‡πà‡∏û‡∏ö Template ‡∏´‡∏£‡∏∑‡∏≠ Service ID";
          }

          showAlert(errorMessage, "error");

          // Store failed notification record
          if (currentUser) {
            await addDoc(collection(db, "emailNotifications"), {
              userId: currentUser.uid,
              to: to,
              subject: subject,
              message: message,
              sentAt: Timestamp.now(),
              type: "manual",
              status: "failed",
              error: error.message,
            });
          }
        } finally {
          showLoading(false);
        }
      }

      async function checkAndSendDueNotifications() {
        // Always check since notifications are always enabled
        if (!notificationSettings.email) {
          console.log(
            "No notification email set, skipping automatic notifications"
          );
          return;
        }

        const now = getBangkokTime();
        const tomorrow = new Date(now);
        tomorrow.setDate(tomorrow.getDate() + 1);

        const dueSoonAssignments = assignments.filter((assignment) => {
          if (assignment.completed) return false;

          const dueDate = new Date(assignment.dueDate);
          const timeDiff = dueDate.getTime() - now.getTime();
          const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

          return daysDiff === 1; // Due tomorrow
        });

        for (const assignment of dueSoonAssignments) {
          // Check if we already sent notification for this assignment
          const notificationId = `${
            assignment.id
          }-${assignment.dueDate.getTime()}`;
          const alreadySent = localStorage.getItem(
            `notification_${notificationId}`
          );

          if (!alreadySent) {
            const subject = `üö® ‡∏á‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${assignment.title}`;
            const message = `
              ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${currentStudentData?.studentId || "‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"},

              ‡∏á‡∏≤‡∏ô "${assignment.title}" ‡πÉ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤ ${
              assignment.subject
            } ‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß!

              üìÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á: ${formatAssignmentDue(assignment)}
              üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${assignment.description || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"}

              ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢

              ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û,
              ‡∏£‡∏∞‡∏ö‡∏ö Assignment Planner
            `;

            await sendEmailNotification(
              notificationSettings.email,
              subject,
              message
            );
            localStorage.setItem(`notification_${notificationId}`, "sent");
          }
        }
      }

      function startNotificationCheck() {
        // Check for due assignments every hour
        setInterval(checkAndSendDueNotifications, 60 * 60 * 1000);

        // Also check immediately
        setTimeout(checkAndSendDueNotifications, 5000);
      }

      function showEmailModal(assignmentId) {
        const assignment = assignments.find((a) => a.id === assignmentId);
        if (!assignment) return;

        document.getElementById("recipientEmail").value =
          notificationSettings.email || "";
        document.getElementById(
          "emailSubject"
        ).value = `‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ${assignment.title}`;
        document.getElementById("emailMessage").value = `
‡∏á‡∏≤‡∏ô: ${assignment.title}
‡∏ß‡∏¥‡∏ä‡∏≤: ${assignment.subject}
‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á: ${formatAssignmentDue(assignment)}
‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${assignment.description || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"}
        `.trim();

        document.getElementById("emailModal").classList.add("active");
      }

      function closeEmailModal() {
        document.getElementById("emailModal").classList.remove("active");
      }

      function showTab(tabName) {
        document.querySelectorAll(".tab-btn").forEach((tab) => {
          tab.classList.remove("active");
        });

        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });

        setTimeout(() => {
          document
            .querySelector(`[onclick="showTab('${tabName}')"]`)
            .classList.add("active");
          document.getElementById(`${tabName}Tab`).classList.add("active");

          if (tabName === "assignments") {
            renderAssignments();
          } else if (tabName === "exams") {
            renderExams();
          } else if (tabName === "calendar") {
            generateCalendar();
          }
        }, 100);
      }

      function renderAssignments() {
        const assignmentsList = document.getElementById("assignmentsList");
        const activeAssignments = assignments.filter(
          (a) => a.type === "assignment" && !a.completed
        );

        if (activeAssignments.length === 0) {
          assignmentsList.innerHTML = `
            <div class="empty-state">
              <i class="bi bi-file-text"></i>
              <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô!</p>
            </div>
          `;
          return;
        }

        assignmentsList.innerHTML = activeAssignments
          .map((assignment) => {
            const dueDate = new Date(assignment.dueDate);
            const now = getBangkokTime();
            const isOverdue = dueDate < now;
            const isDueSoon = dueDate - now < 2 * 24 * 60 * 60 * 1000;

            let statusClass = "";
            if (isOverdue) statusClass = "overdue";
            else if (isDueSoon) statusClass = "due-soon";

            return `
              <div class="assignment-item ${statusClass}">
                <div class="assignment-header">
                  <div class="assignment-title">${
                    assignment.title || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠"
                  }</div>
                  <div class="assignment-subject">${
                    assignment.subject || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤"
                  }</div>
                </div>
                <div class="assignment-due">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á: ${formatAssignmentDue(
                  assignment
                )}</div>
                <div class="assignment-description">${
                  assignment.description || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"
                }</div>
                <div class="assignment-actions">
                  <button class="btn-small btn-edit" onclick="editAssignment('${
                    assignment.id
                  }')">
                    <i class="bi bi-pencil"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                  </button>
                  <button class="btn-small btn-complete" onclick="completeAssignment('${
                    assignment.id
                  }')">
                    <i class="bi bi-check"></i> ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
                  </button>
                  <button class="btn-small btn-notify" onclick="showEmailModal('${
                    assignment.id
                  }')">
                    <i class="bi bi-envelope"></i> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                  </button>
                  <button class="btn-small btn-delete" onclick="deleteAssignment('${
                    assignment.id
                  }')">
                    <i class="bi bi-trash"></i> ‡∏•‡∏ö
                  </button>
                </div>
              </div>
            `;
          })
          .join("");
      }

      function renderExams() {
        const examsList = document.getElementById("examsList");
        const exams = assignments.filter(
          (a) => a.type === "exam" && !a.completed
        );

        if (exams.length === 0) {
          examsList.innerHTML = `
            <div class="empty-state">
              <i class="bi bi-pencil-square"></i>
              <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°!</p>
            </div>
          `;
          return;
        }

        examsList.innerHTML = exams
          .map(
            (exam) => `
              <div class="assignment-item">
                <div class="assignment-header">
                  <div class="assignment-title">${
                    exam.title || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠"
                  }</div>
                  <div class="assignment-subject">${
                    exam.subject || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤"
                  }</div>
                </div>
                <div class="assignment-due">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatAssignmentDue(
                  exam
                )}</div>
                <div class="assignment-description">${
                  exam.description || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"
                }</div>
                <div class="assignment-actions">
                  <button class="btn-small btn-edit" onclick="editAssignment('${
                    exam.id
                  }')">
                    <i class="bi bi-pencil"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                  </button>
                  <button class="btn-small btn-notify" onclick="showEmailModal('${
                    exam.id
                  }')">
                    <i class="bi bi-envelope"></i> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                  </button>
                  <button class="btn-small btn-delete" onclick="deleteAssignment('${
                    exam.id
                  }')">
                    <i class="bi bi-trash"></i> ‡∏•‡∏ö
                  </button>
                </div>
              </div>
            `
          )
          .join("");
      }

      function generateCalendar() {
        const calendarGrid = document.getElementById("calendarGrid");
        const calendarMonth = document.getElementById("calendarMonth");

        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();

        calendarMonth.textContent = new Date(year, month).toLocaleDateString(
          "th-TH",
          {
            month: "long",
            year: "numeric",
          }
        );

        const firstDay = new Date(year, month, 1);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());

        const calendarHTML = [];
        const dayHeaders = ["‡∏≠‡∏≤", "‡∏à", "‡∏≠", "‡∏û", "‡∏û‡∏§", "‡∏®", "‡∏™"];

        dayHeaders.forEach((day) => {
          calendarHTML.push(`
            <div class="calendar-day" style="font-weight: 600; background: linear-gradient(135deg, #1e88e5, #1565c0); color: white; cursor: default;">
              ${day}
            </div>
          `);
        });

        const today = getBangkokDateOnly();

        for (let i = 0; i < 42; i++) {
          const currentDate = new Date(startDate);
          currentDate.setDate(startDate.getDate() + i);

          const isCurrentMonth = currentDate.getMonth() === month;
          const isToday = currentDate.getTime() === today.getTime();

          const dayAssignments = assignments.filter((assignment) => {
            const assignmentDate = getBangkokDateOnly(assignment.dueDate);
            return (
              assignmentDate.getTime() === currentDate.getTime() &&
              !assignment.completed
            );
          });

          let classes = "calendar-day";
          if (!isCurrentMonth) classes += " other-month";
          if (isToday) classes += " today";
          if (dayAssignments.length > 0) classes += " has-assignment";

          let dotClass =
            dayAssignments.length > 1
              ? "assignment-dot multiple"
              : "assignment-dot";

          calendarHTML.push(`
            <div class="${classes}" title="${
            dayAssignments.length > 0
              ? dayAssignments.map((a) => a.title).join(", ")
              : ""
          }">
              <span>${currentDate.getDate()}</span>
              ${
                dayAssignments.length > 0
                  ? `<div class="${dotClass}"></div>`
                  : ""
              }
            </div>
          `);
        }

        calendarGrid.innerHTML = calendarHTML.join("");
        updateUpcomingAssignments();
      }

      function updateUpcomingAssignments() {
        const upcomingList = document.getElementById("upcomingAssignmentsList");
        const now = getBangkokTime();
        const upcoming = assignments
          .filter((a) => !a.completed && new Date(a.dueDate) > now)
          .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
          .slice(0, 8);

        if (upcoming.length === 0) {
          upcomingList.innerHTML = `
            <div class="assignment-info" style="justify-content: center;">
              <span style="color: #666; font-style: italic;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á</span>
            </div>
          `;
          return;
        }

        upcomingList.innerHTML = upcoming
          .map((assignment) => {
            const dueDate = new Date(assignment.dueDate);
            const diffTime = dueDate.getTime() - now.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            let dateText;
            if (diffDays === 0) dateText = "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ";
            else if (diffDays === 1) dateText = "‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ";
            else if (diffDays < 7) dateText = `${diffDays} ‡∏ß‡∏±‡∏ô`;
            else
              dateText = dueDate.toLocaleDateString("th-TH", {
                timeZone: "Asia/Bangkok",
                month: "short",
                day: "numeric",
              });

            return `
              <div class="assignment-info">
                <div>
                  <div class="assignment-info-title">${assignment.title}</div>
                  <div style="font-size: 12px; color: #666;">${
                    assignment.subject
                  }${
              assignment.period ? ` - ‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà ${assignment.period}` : ""
            }</div>
                </div>
                <div class="assignment-info-date">${dateText}</div>
              </div>
            `;
          })
          .join("");
      }

      function changeMonth(direction) {
        currentCalendarDate.setMonth(
          currentCalendarDate.getMonth() + direction
        );
        generateCalendar();
      }

      function showAddModal() {
        document.getElementById("modalTitle").textContent = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô";
        document.getElementById("assignmentForm").reset();
        editingAssignmentId = null;
        document.getElementById("assignmentModal").classList.add("active");
      }

      function closeModal() {
        document.getElementById("assignmentModal").classList.remove("active");
        editingAssignmentId = null;
      }

      function editAssignment(id) {
        const assignment = assignments.find((a) => a.id === id);
        if (!assignment) return;

        document.getElementById("modalTitle").textContent = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô";
        document.getElementById("assignmentTitle").value =
          assignment.title || "";
        document.getElementById("assignmentSubject").value =
          assignment.subject || "";
        document.getElementById("assignmentType").value = assignment.type || "";
        document.getElementById("assignmentDescription").value =
          assignment.description || "";

        const dueDate = new Date(assignment.dueDate);
        if (!isNaN(dueDate.getTime())) {
          // Convert to Bangkok timezone for the date input
          const bangkokDate = new Date(
            dueDate.toLocaleString("en-US", { timeZone: "Asia/Bangkok" })
          );
          const formattedDate = bangkokDate.toISOString().split("T")[0];
          document.getElementById("assignmentDate").value = formattedDate;
        }

        document.getElementById("assignmentPeriod").value =
          assignment.period || "1";

        editingAssignmentId = id;
        document.getElementById("assignmentModal").classList.add("active");
      }

      function deleteAssignment(id) {
        if (confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?")) {
          deleteAssignmentFromDb(id);
        }
      }

      function completeAssignment(id) {
        markAssignmentComplete(id);
      }

      async function logout() {
        try {
          showLoading(true);
          if (assignmentListener) {
            assignmentListener();
          }
          await signOut(auth);
          window.location.href = "index.html";
        } catch (error) {
          console.error("Logout error:", error);
          showAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö: " + error.message, "error");
        } finally {
          showLoading(false);
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Assignment form handler
        document
          .getElementById("assignmentForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();

            const title = document
              .getElementById("assignmentTitle")
              .value.trim();
            const subject = document.getElementById("assignmentSubject").value;
            const date = document.getElementById("assignmentDate").value;
            const period = document.getElementById("assignmentPeriod").value;
            const type = document.getElementById("assignmentType").value;
            const description = document
              .getElementById("assignmentDescription")
              .value.trim();

            if (!title || !subject || !date || !period || !type) {
              showAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", "error");
              return;
            }

            // Create date in Bangkok timezone
            let dueDate = new Date(date + "T00:00:00");

            if (period === "end-of-day") {
              dueDate.setHours(17, 0, 0, 0);
            } else {
              const periodTimes = {
                1: [8, 30],
                2: [9, 20],
                3: [10, 15],
                4: [11, 5],
                5: [11, 55],
                6: [12, 45],
                7: [13, 35],
                8: [14, 30],
                9: [15, 20],
                10: [16, 10],
              };
              const [hours, minutes] = periodTimes[period] || [9, 0];
              dueDate.setHours(hours, minutes, 0, 0);
            }

            const assignmentData = {
              title,
              subject,
              dueDate: Timestamp.fromDate(dueDate),
              period,
              type,
              description,
              completed: false,
            };

            if (editingAssignmentId) {
              await updateAssignment(editingAssignmentId, assignmentData);
            } else {
              await saveAssignment(assignmentData);
            }

            closeModal();
            this.reset();
          });

        // Email form handler
        document
          .getElementById("emailForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();

            const to = document.getElementById("recipientEmail").value.trim();
            const subject = document
              .getElementById("emailSubject")
              .value.trim();
            const message = document
              .getElementById("emailMessage")
              .value.trim();

            if (!to || !subject || !message) {
              showAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", "error");
              return;
            }

            showLoading(true);
            await sendEmailNotification(to, subject, message);
            showLoading(false);
            closeEmailModal();
            this.reset();
          });

        // Notification email input handler
        document
          .getElementById("notificationEmail")
          .addEventListener("blur", function (e) {
            notificationSettings.email = e.target.value.trim();
            saveNotificationSettings();
          });

        // Modal click handlers
        document
          .getElementById("assignmentModal")
          .addEventListener("click", function (e) {
            if (e.target === this) {
              closeModal();
            }
          });

        document
          .getElementById("emailModal")
          .addEventListener("click", function (e) {
            if (e.target === this) {
              closeEmailModal();
            }
          });

        generateCalendar();
      });

      window.showTab = showTab;
      window.showAddModal = showAddModal;
      window.closeModal = closeModal;
      window.editAssignment = editAssignment;
      window.deleteAssignment = deleteAssignment;
      window.completeAssignment = completeAssignment;
      window.changeMonth = changeMonth;
      window.logout = logout;
      window.showEmailModal = showEmailModal;
      window.closeEmailModal = closeEmailModal;
    </script>
  </body>
</html>
